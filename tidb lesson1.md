# tidb lesson1

1.fork了主库代码 tidb tikv pd clone到本地<br />2.首先改tidb源码，找到开启事务代码位置<br />查看tidb 源码解析博客   [初识 TiDB 源码](https://pingcap.com/blog-cn/tidb-source-code-reading-2/#tidb-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E4%BA%8C%E5%88%9D%E8%AF%86-tidb-%E6%BA%90%E7%A0%81) 了解代码结构<br />查看tidb 源码解析博客  [sql的一生](https://pingcap.com/blog-cn/tidb-source-code-reading-3/)<br />tidb 入口：当和客户端的连接建立好之后，TiDB 中会有一个 Goroutine 监听端口，等待从客户端发来的包，并对发来的包做处理。<br />[clientConn.Run()](https://github.com/pingcap/tidb/blob/source-code/server/conn.go#L413) 代码开始追踪，看到这里对不同类型的语句命令不同处理<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/1389378/1597409321634-53c91c0e-81da-466e-8ce1-e4343a98210b.png#align=left&display=inline&height=699&margin=%5Bobject%20Object%5D&name=image.png&originHeight=699&originWidth=875&size=73159&status=done&style=none&width=875)<br />进到case mysql.ComStmtExecute的处理方法看一看<br />进入到stmt.Execute(ctx, args) 看一看<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/1389378/1597409601974-b5a9c70e-b8fd-40d1-9653-2afae2f502ec.png#align=left&display=inline&height=266&margin=%5Bobject%20Object%5D&name=image.png&originHeight=266&originWidth=1169&size=27862&status=done&style=none&width=1169)<br />driver_tidb.go实现了PreparedStatement Execute method<br />怀疑这个位置为开始事务代码，<br />加上一句logutil.Logger(ctx).Info("hello transaction")<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/1389378/1597410383500-1c6b1a58-dcd8-45b5-9f5e-418064c9fadf.png#align=left&display=inline&height=513&margin=%5Bobject%20Object%5D&name=image.png&originHeight=513&originWidth=1236&size=59616&status=done&style=none&width=1236)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/1389378/1597412697825-66a1b3e2-222b-4ecb-aa32-cddddca83ccc.png#align=left&display=inline&height=464&margin=%5Bobject%20Object%5D&name=image.png&originHeight=464&originWidth=1128&size=49932&status=done&style=none&width=1128)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/1389378/1597412726596-dc70ebd8-7568-48d1-a1c2-2d2d010755f4.png#align=left&display=inline&height=265&margin=%5Bobject%20Object%5D&name=image.png&originHeight=265&originWidth=800&size=51931&status=done&style=none&width=800)<br />编译后发现一直打印这条日志，再追踪代码到编译preparedStmt这块<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/1389378/1597411153517-d3a52c54-f2f2-41f2-b6ac-262969212a16.png#align=left&display=inline&height=655&margin=%5Bobject%20Object%5D&name=image.png&originHeight=655&originWidth=907&size=58991&status=done&style=none&width=907)<br />3.编译部署<br />用了tiup playground ，按照文档说明<br />安装tiup cluster组件  安装playground<br />tiup playground --db=1 --kv=3 --pd=1 --host 10.30.23.63 启动部署<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/1389378/1597412965477-21abe902-aadc-4fe5-81e5-83c99b3adfdf.png#align=left&display=inline&height=353&margin=%5Bobject%20Object%5D&name=image.png&originHeight=353&originWidth=1320&size=39819&status=done&style=none&width=1320)<br />ps -ef|grep tiup 看下进程 杀掉tidb<br />上传代码到linux 进入tidb代码目录 make编译，其中安装了go环境，设置goproxy代理<br />按照之前playround进程命令启动编译的tidb<br />./bin/tidb-server -P 4000 --store=tikv --host=10.30.23.63 --status=10080 --path=10.30.23.63:2379 --log-file=./tidb.log &<br />
<br />
<br />
<br />
<br />
<br />
<br />

